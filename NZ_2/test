create or replace procedure correlation(int4,int4) returns int4
language nzplsql as
begin_proc
declare
   rows int4;
   cols int4;
   stmt varchar;
   qry varchar; 
   temp varchar;
   cal varchar;
   temp_qry varchar;
   start_time time;
   end_time time;
   time_taken time;
   start time;
   total_time_taken time;

begin
  rows:=$1;
  cols:=$2;
  --generate a data matrix
  
    select current_time into start;
 
   select current_time into start_time;
   create table example as (select * from table(matrix_generate(rows,cols))) distribute on random;
   select current_time into end_time;
   time_taken:= end_time-start_time;
   --execute immediate 'insert into '|| reftablename ||' values(Time_data_matrix,'|| 'time_taken' ||')';
   raise notice 'Time to generate data matrix  %',time_taken;
  --generate statement to create the corelation matrix
 
--===========================================================================
 qry:='create table output( X';

  for i in 1..($2-1)
    loop
     qry:=qry || i ||' double, X';
    end loop;
   qry:=qry || $2 ||' double, row int)';
 
   --raise notice '%',qry;
   execute immediate qry;
   raise notice 'Output table created';


-- correlation matrix building step.
--==========================================================================   
 
 stmt := 'insert into output select ';
  select current_time into start_time;
  
   for i in 1..$2
      loop
      temp:= stmt;
     for j in 1..($2-1)
       loop
      temp:= temp || 'cor(X'|| i ||',X'||j||'),';
      end loop;
      temp:=temp || 'cor(X'|| i|| ',X'|| $2|| '), '|| i||' from example';
     --raise notice '%',temp;
    execute immediate temp;
  end loop;

   select current_time into end_time;
   time_taken:= end_time-start_time;
   --execute immediate 'insert into '|| reftablename ||' values(Time_generate_correlation_matrix,'|| 'time_taken' ||')';
   raise notice 'Time to generate correlation matrix our own UDA  %',time_taken;

--correlation builging with inbuilt 'nza..corr' function
--=======================================================================================

--output schema creation

qry:='create table outputz( X';

  for i in 1..($2-1)
    loop
     qry:=qry || i ||' double, X';
    end loop;
   qry:=qry || $2 ||' double, row int)';
 
   --raise notice '%',qry;
   execute immediate qry;
  
 -- correlation calculation 

stmt := 'insert into outputz select ';
  select current_time into start_time;
  
   for i in 1..$2
      loop
      temp:= stmt;
     for j in 1..($2-1)
       loop
      temp:= temp || 'nza..corr_agg(X'|| i ||',X'||j||'),';
      end loop;
      temp:=temp || 'nza..corr_agg(X'|| i|| ',X'|| $2|| '), '|| i||' from example';
     --raise notice '%',temp;
    execute immediate temp;
  end loop;

   select current_time into end_time;
   time_taken:= end_time-start_time;
   --execute immediate 'insert into '|| reftablename ||' values(Time_generate_correlation_matrix,'|| 'time_taken' ||')';
   raise notice 'Time to generate correlation matrix using in-built corr_agg function :  %',time_taken;

--verification using nza..corr_matrix_agg
--======================================================================================
stmt:='create table nz_corr_matrix as (select nza..corr_matrix_agg('||$2||','||$2;
for i IN 1..$2 
loop
stmt:=stmt||',X'||i||'';
end loop;
for i IN 1..$2
 loop
stmt:=stmt ||',X'||i||'';
end loop;
stmt:=stmt||') from example);';

--raise notice 'query %',stmt;
select current_time into start_time; 
execute immediate stmt;
select current_time into end_time;
time_taken:=end_time-start_time;

raise notice 'Time to generate correlation matrix using nza..corr_matrix_agg is % ',time_taken;

--==========================================================================================
-- need to compare values in two tables "output" and "output2"

  raise notice 'Comparing the two tables generated by two different aggregates';
  --select * from output minus select * from outputz;
  -- we create two tables with rounded off values and use 'minus' operator on those two tables 

 qry:='create table output_own as select round( X';

  for i in 1..($2-1)
    loop
     qry:=qry || i ||', 10) as X'|| i||',round (X';
    end loop;
   qry:=qry || $2 ||', 10) as X'|| $2||' from output';
 
   --raise notice '%',qry;
  
   execute immediate qry;
  

qry:='create table output_inbult as select round( X';

  for i in 1..($2-1)
    loop
     qry:=qry || i ||', 6) as X'|| i||',round (X';
    end loop;
   qry:=qry || $2 ||', 6) as X'|| $2||' from outputz';
 
   --raise notice '%',qry;
  
   execute immediate qry;
 

   create table final_result as select * from output_own minus select * from output_inbult union select * from output_inbult minus select * from output_own;
-- correlation pair table generation step
--============================================================================
 create table top_pairs(i int, j int, cfactor double);

 select current_time into start_time;
  for i in 1..$2-1
   loop
    for j in (i+1)..$2
      loop
     cal:='insert into top_pairs select ' || i||',' ||j||',X'||j||' from output where row='|| i||'';
     --raise notice '%',cal;
     execute immediate cal;
    end loop;
  end loop;
  
   select current_time into end_time;
   time_taken:= end_time-start_time;
   --execute immediate 'insert into '|| reftablename ||' values(Time_top_10_pairs,'|| 'time_taken' ||')';
   raise notice 'Time to extract top ten correlation pairs  %',time_taken;

   total_time_taken=end_time-start;

   --execute immediate 'insert into '|| reftablename ||' values(Time_taken_whole_process,'|| 'time_taken' ||')';
   raise notice 'Total time taken %',total_time_taken;

 
   return reftable;
end;
end_proc;

